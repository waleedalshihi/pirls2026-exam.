<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحليل نتائج PIRLS2026</title>
  <style>
    body{font-family:"Tahoma", Arial, sans-serif; background:#f6f6f6; color:#222; margin:0;}
    .page{max-width:1100px; margin:0 auto; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.1);}    
    header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:4px solid #005a9e;}
    header .right{ text-align:right;}
    header .right h1{font-size:18px; margin:0;}
    header .right h2{font-size:15px; margin:4px 0 0; color:#555;}
    header .left{display:flex; gap:12px; align-items:center;}
    header img.logo{height:64px; width:auto; object-fit:contain;}
    .content{padding:20px;}
    .uploader{border:2px dashed #cdd9f7; padding:14px; border-radius:8px; background:#f0f6ff;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:20px;}
    canvas{background:#fcfcfc; border:1px solid #eee; border-radius:8px;}
    table{width:100%; border-collapse:collapse; margin-top:20px;}
    th, td{border:1px solid #ddd; padding:8px;}
    th{background:#f5f5f5;}
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="right">
      <h1>المديرية العامة للتربية والتعليم بمحافظة مسندم</h1>
      <h2>دائرة القياس والتقويم التربوي</h2>
    </div>
    <div class="left">
      <img src="../شعار القياس والتقويم التربوي.jpg" alt="شعار القياس" class="logo"/>
      <img src="../شعار رؤية عمان.png" alt="رؤية عمان" class="logo"/>
    </div>
  </header>
  <div class="content">
    <h3>لوحة تحليل نتائج PIRLS2026</h3>
    <div class="uploader">
      <p>ارفع ملفات نتائج CSV التي تم تنزيلها من الاختبار، ويمكن رفع عدة ملفات وسيتم دمجها تلقائيًا.</p>
      <input type="file" id="fileInput" accept=".csv" multiple />
    </div>

    <div class="grid">
      <div>
        <h4>متوسط الدرجات حسب المدرسة</h4>
        <canvas id="schoolChart" width="500" height="300"></canvas>
      </div>
      <div>
        <h4>توزيع الدرجات</h4>
        <canvas id="distChart" width="500" height="300"></canvas>
      </div>
    </div>

    <h4>جدول النتائج</h4>
    <table id="resultsTable">
      <thead><tr id="hdr"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(',');
    const values = lines[1].split(',');
    const obj = {};
    headers.forEach((h,i)=> obj[h] = values[i]);
    return {headers, obj};
  }

  const all = [];

  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    for(const f of files){
      const text = await f.text();
      const {headers, obj} = parseCSV(text);
      all.push(obj);
    }
    render();
  });

  function render(){
    if(all.length===0) return;
    // Render table
    const headers = Object.keys(all[0]);
    const hdr = document.getElementById('hdr');
    hdr.innerHTML = headers.map(h=>`<th>${h}</th>`).join('');
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = all.map(r=>`<tr>${headers.map(h=>`<td>${r[h]||''}</td>`).join('')}</tr>`).join('');

    // Compute charts data
    const bySchool = {};
    const scores = [];
    all.forEach(r => {
      const s = r.school || 'غير محدد';
      const sc = Number(r.score||0);
      const tot = Number(r.total||12);
      if(!bySchool[s]) bySchool[s] = {sum:0, n:0};
      bySchool[s].sum += sc; bySchool[s].n += 1;
      scores.push(sc);
    });

    const schools = Object.keys(bySchool);
    const avgs = schools.map(k => (bySchool[k].sum/bySchool[k].n));

    drawBar(document.getElementById('schoolChart'), schools, avgs, 'متوسط الدرجة');
    drawHist(document.getElementById('distChart'), scores, 13);
  }

  function drawBar(canvas, labels, data, ylabel){
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width, canvas.height);
    const w = canvas.width, h = canvas.height;
    const padding = 40;
    const maxv = Math.max(...data, 1);
    // axes
    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, h-padding);
    ctx.lineTo(w-padding, h-padding);
    ctx.stroke();
    const barW = (w - 2*padding) / labels.length * 0.7;
    data.forEach((v,i)=>{
      const x = padding + i * ((w - 2*padding)/labels.length) + ((w - 2*padding)/labels.length - barW)/2;
      const y = h - padding - (v/maxv) * (h - 2*padding);
      ctx.fillStyle = '#005a9e';
      ctx.fillRect(x, y, barW, h - padding - y);
      ctx.fillStyle = '#000';
      ctx.font = '12px Tahoma';
      ctx.fillText(labels[i], x, h - padding + 14);
      ctx.fillText(v.toFixed(2), x, y - 5);
    });
    ctx.save();
    ctx.rotate(-Math.PI/2);
    ctx.fillText(ylabel, -h/2, 16);
    ctx.restore();
  }

  function drawHist(canvas, data, bins){
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width, canvas.height);
    const w = canvas.width, h = canvas.height;
    const padding = 40;
    const min = 0, max = Math.max(...data, 12);
    const binW = (max-min)/bins;
    const counts = new Array(bins).fill(0);
    data.forEach(v => {
      let idx = Math.floor((v-min)/binW);
      if(idx >= bins) idx = bins - 1;
      counts[idx]++;
    });
    const maxc = Math.max(...counts);
    // axes
    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, h-padding);
    ctx.lineTo(w-padding, h-padding);
    ctx.stroke();
    const barW = (w - 2*padding) / bins * 0.9;
    counts.forEach((c,i)=>{
      const x = padding + i * ((w - 2*padding)/bins) + (((w - 2*padding)/bins) - barW)/2;
      const y = h - padding - (c/maxc) * (h - 2*padding);
      ctx.fillStyle = '#107c10';
      ctx.fillRect(x, y, barW, h - padding - y);
      ctx.fillStyle = '#000';
      ctx.font = '11px Tahoma';
      ctx.fillText(String(c), x, y - 5);
    });
    ctx.save();
    ctx.rotate(-Math.PI/2);
    ctx.fillText('عدد الطلبة', -h/2, 16);
    ctx.restore();
  }
</script>
</body>
</html>